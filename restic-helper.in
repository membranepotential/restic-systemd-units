#!/bin/bash

concatEnvFile() {
	# conca line continuation in file
	sed ':a;N;$!ba;s/\\\n[[:space:]]*//g' "$1" |
		sed -E 's/^([[:alnum:]_]+)=([^"].*[^"])$/\1="\2"/'
}

: "${RESTIC_BIN:=@RESTIC_BIN@}"
: "${RESTIC_CACHE_DIR:=@RESTIC_CACHE_DIR@}"

export RESTIC_CACHE_DIR

set -a
for conf in /etc/restic/restic.conf ./restic.conf; do
	if [[ -f $conf ]]; then
		echo "* reading configuration from $conf" >&2
		eval "$(concatEnvFile $conf)"
	fi
done
set +a

exec $RESTIC_BIN $RESTIC_COMMON_ARGS "$@"
